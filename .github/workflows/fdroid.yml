name: Generate F-Droid repo

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  repository_dispatch:
    types: [new-release]
  schedule:
  - cron: "45 2 * * *"
permissions:
  contents: write

jobs:
  apps:
    name: "Generate repo from apps listing"
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Create basic directory structure
        run: mkdir -p fdroid/repo

      - name: Restore correct mtime
        run: |
          python3 -c "
          import subprocess
          import os
          from pathlib import Path
          
          # Get all files tracked by git with their last commit timestamp
          result = subprocess.run(
              ['git', 'log', '--pretty=%at', '--name-status', '--diff-filter=AMRC'],
              capture_output=True, text=True, check=True
          )
          
          files = {}
          current_time = None
          
          for line in result.stdout.splitlines():
              line = line.strip()
              if not line:
                  continue
              if line.isdigit():
                  current_time = int(line)
              elif current_time and '\t' in line:
                  parts = line.split('\t')
                  if len(parts) >= 2:
                      filepath = parts[-1]
                      if filepath not in files and Path(filepath).exists():
                          files[filepath] = current_time
          
          # Set mtime for all files
          for filepath, timestamp in files.items():
              try:
                  os.utime(filepath, (timestamp, timestamp))
              except:
                  pass
          "

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Cache Nix store
        uses: cachix/cachix-action@v15
        with:
          name: baxter
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
          skipPush: ${{ secrets.CACHIX_AUTH_TOKEN == '' }}

      - name: Set up repo secrets
        run: |
          echo "${{ secrets.KEYSTORE_P12 }}" | base64 -d - > fdroid/keystore.p12
          echo "${{ secrets.CONFIG_YML }}" | base64 -d - > fdroid/config.yml
          chmod 600 fdroid/config.yml
        
      - name: Run update script
        run: bash update.sh 2>&1
        env:
          GH_ACCESS_TOKEN: ${{ secrets.GH_ACCESS_TOKEN }}

      - name: Commit and push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add . --all
          git commit -m "Automated update"
          git push
